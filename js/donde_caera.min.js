nivel={facil:{columnas:3,filas:6,bloques_activos:{min:1,max:3},tiempo_para_elegir:3000},medio:{columnas:3,filas:8,bloques_activos:{min:2,max:4},tiempo_para_elegir:4000},dificil:{columnas:4,filas:10,bloques_activos:{min:3,max:5},tiempo_para_elegir:5000}};function Juego(){var h={num_niveles:document.getElementsByName("elegir_dificultad"),area_juego:document.querySelector("#area_juego"),temporizador:document.querySelector("#temporizador"),overlay_juego:document.querySelector("#overlay_juego"),correcto_incorrecto:document.querySelector("#correcto_incorrecto"),tiempo_para_elegir:document.querySelector("#tiempo_para_elegir"),puntos:document.querySelector("#puntaje_parcial"),pregunta:document.querySelector("#pregunta")};var g={dificultad:"medio",duracion:90000};var q=new Controlador_objetos(nivel.dificil.bloques_activos.max);var v=new PuntajeParcial();var w=(window.localStorage)?new Puntajes():null;var u=new Opciones();var c;var n;var a=function(){h.correcto_incorrecto.setAttribute("class","Correcto")};var d=function(){h.correcto_incorrecto.setAttribute("class","Incorrecto")};var t=function(){h.correcto_incorrecto.style.display="none"};var p=function(x){h.correcto_incorrecto.style.top=(h.area_juego.offsetTop+h.area_juego.clientHeight-70)+"px";h.correcto_incorrecto.style.left=((h.area_juego.clientWidth/nivel[g.dificultad].columnas)*x)+"px";h.correcto_incorrecto.style.display="block"};var f=function(x){q.cancelar_caida(g.dificultad);h.puntos.firstChild.nodeValue=v.calcular(u.get_opcion_elegida()==x);(u.get_opcion_elegida()==x)?a():d();p(x);n=window.setTimeout(function(){t();b()},1000)};this.mostrarPuntajes=function(){if(window.localStorage){w.mostrarPuntajes(g.dificultad)}};var e=function(){u.deshabilitar_elegir_opcion();q.dejar_caer(g.dificultad,c,f)};var s=function(){o.detener();q.dejar_caer(g.dificultad,c,f)};var m=function(){u.deshabilitar_elegir_opcion();o.detener();q.cancelar_caida(g.dificultad);h.temporizador.firstChild.nodeValue="--:--";h.tiempo_para_elegir.firstChild.nodeValue="--"};this.reconf=function(){r.detener();m();q.ocultar();clearTimeout(n);t();for(var x=0;x<h.num_niveles.length;x++){if(h.num_niveles[x].checked){g.dificultad=h.num_niveles[x].value}}v.restablecer();h.overlay_juego.style.display="block";h.puntos.firstChild.nodeValue="0";h.pregunta.style.visibility="hidden";u.quitar_atributo_opcion_elegida();this.mostrarPuntajes()};var b=function(){if(!r.finalizado()){u.quitar_atributo_opcion_elegida();c=Bloque(g.dificultad);q.establecer_comienzo(g.dificultad);u.agregar(g.dificultad,s);h.overlay_juego.style.display="none";o.setTiempo(nivel[g.dificultad].tiempo_para_elegir);o.iniciar()}else{m();if(window.localStorage){w.esNuevoRecord(v.getPuntos(),g.dificultad)}}};var r=new Temporizador(h.temporizador,b,g.duracion,"M:S");var o=new Temporizador(h.tiempo_para_elegir,e,nivel[g.dificultad].tiempo_para_elegir,"s");this.iniciar=function(){v.restablecer();h.puntos.firstChild.nodeValue="0";h.pregunta.style.visibility="visible";q.cancelar_caida(g.dificultad);r.iniciar();b()};this.reiniciar=function(){}}function Opciones(){var f={area_juego:document.querySelector("#area_juego"),area_opciones:document.querySelector("#area_opciones"),opciones:new Array()};var b;var a=false;this.get_opcion_elegida=function(){return b};var d=function(){for(var g=0;g<f.opciones.length;g++){f.opciones[g].setAttribute("class","opciones opciones-deshablitadas")}};var c=function(g){f.opciones=document.querySelectorAll(".opciones");for(var h=0;h<f.opciones.length;h++){f.opciones[h].addEventListener("click",function(){if(!a){b=this.getAttribute("id");a=true;this.setAttribute("name","opcion_elegida");d();g()}},false)}};this.agregar=function(h,g){letra=new Array("a","b","c","d","e");nodo_opcion=new Array();ancho_columna=100/nivel[h].columnas;a=false;while(f.area_opciones.childNodes.length>0){f.area_opciones.removeChild(f.area_opciones.lastChild)}for(var m=0;m<=nivel[h].columnas;m++){nodo_opcion[m]=document.createElement("div");nodo_opcion[m].setAttribute("class","opciones");nodo_opcion[m].setAttribute("id",m);f.area_opciones.appendChild(nodo_opcion[m]);descuento=(Math.floor(nodo_opcion[m].clientWidth/2)*100)/f.area_juego.clientWidth;nodo_opcion[m].style.left=((ancho_columna*m)-descuento)+"%";nodo_opcion[m].appendChild(document.createTextNode(letra[m]))}c(g)};var e=function(){f.opciones=document.querySelectorAll(".opciones");for(var g=0;g<f.opciones.length;g++){if(f.opciones[g].getAttribute("name")=="opcion_elegida"){return f.opciones[g]}}};this.quitar_atributo_opcion_elegida=function(){nodo_opcion_elegida=e();if(typeof(nodo_opcion_elegida)!="undefined"){nodo_opcion_elegida.removeAttribute("name","opcion_elegida")}};this.deshabilitar_elegir_opcion=function(){if(!a){a=true;b=-1}d()}}function Bloque(a){var b={area_juego:document.querySelector("#area_juego")};crear_bloques=function(){eliminar=function(){while(b.area_juego.childNodes.length>0){b.area_juego.removeChild(b.area_juego.lastChild)}};agregar=function(){ancho_columna=100/nivel[a].columnas;alto_fila=100/(nivel[a].filas+1);for(var d=0;d<nivel[a].columnas;d++){nodo_columna=document.createElement("div");nodo_columna.setAttribute("class","columna");nodo_columna.style.width=ancho_columna+"%";b.area_juego.appendChild(nodo_columna);for(var c=0;c<nivel[a].filas;c++){nodo_fila=document.createElement("div");nodo_fila.style.height=alto_fila+"%";nodo_columna.appendChild(nodo_fila)}}};eliminar();agregar()};definir_num_bloques_activos=function(){num_bloques_activos=new Array();for(var c=0;c<nivel[a].columnas;c++){num_bloques_activos[c]=Math.round(Math.random()*(nivel[a].bloques_activos.max-nivel[a].bloques_activos.min))+nivel[a].bloques_activos.min}return num_bloques_activos};definir_bloques_activos=function(g){num_bloques_activos=definir_num_bloques_activos();var c=new Array();for(var f=0;f<nivel[a].filas;f++){c.push(f)}num_seleccionados=new Array(2);num_seleccionados[0]=new Array();num_seleccionados[1]=new Array();for(var f=0;f<nivel[a].columnas;f++){if(f>1){for(var d=0;d<num_seleccionados[f%2].length;d++){c.push(num_seleccionados[f%2][d])}num_seleccionados[f%2].splice(0,num_seleccionados[f%2].length)}for(var e=0;e<num_bloques_activos[f];e++){posicion=Math.round(Math.random()*(c.length-1));num_aleatorio=c.splice(posicion,1);num_seleccionados[f%2].push(num_aleatorio);g[f][num_aleatorio].activo=true;g[f][num_aleatorio].div.setAttribute("class","activo")}}};definir_bloques=function(){crear_bloques();bloque=new Array();for(var d=0;d<nivel[a].columnas;d++){bloque[d]=new Array();for(var c=0;c<nivel[a].filas;c++){bloque[d][c]={div:document.querySelector("#area_juego > .columna:nth-child("+(d+1)+") > div:nth-child("+(c+1)+")"),activo:false}}}definir_bloques_activos(bloque);return bloque};return definir_bloques()}function Controlador_objetos(d){var f={preguntar_color:document.querySelector("#pregunta > p span")};var g=new Array();for(var b=0;b<d;b++){g[b]=new Objeto(b)}var a={eng:new Array("lime","orange","purple","aqua","fuchsia"),spa:new Array("lima","naranja","morado","agua","fucsia")};this.ocultar=function(){for(var m=0;m<g.length;m++){g[m].ocultar()}};this.cancelar_caida=function(m){for(var n=0;n<=nivel[m].columnas;n++){g[n].cancelar_caida()}};this.dejar_caer=function(m,p,o){for(var n=0;n<=nivel[m].columnas;n++){g[n].dejar_caer(m,p,o)}};var e=function(m){for(var n=0;n<g.length;n++){(n<=nivel[m].columnas)?g[n].mostrar():g[n].ocultar()}};var h=function(m){f.preguntar_color.firstChild.nodeValue=a.spa[m];f.preguntar_color.style.color=a.eng[m]};var c=function(m){objetivo=Math.round(Math.random()*nivel[m].columnas);h(objetivo);for(var n=0;n<=nivel[m].columnas;n++){g[n].set_objetivo(n==objetivo)}};this.establecer_comienzo=function(m){e(m);c(m);for(var n=0;n<=nivel[m].columnas;n++){g[n].establecer_comienzo(m)}}}function Objeto(o){var g=document.createElement("div");g.setAttribute("class","objeto");g.setAttribute("id","objeto_"+(o+1));document.querySelector("#juego").appendChild(g);nodo_area_juego=document.querySelector("#area_juego");var b=o;var m=o;var h=0;var f=false;var d=120;var q=false;var c;var a;this.set_velocidad=function(r){d=r};this.set_columna=function(r){b=r;m=r};this.set_objetivo=function(r){q=r};this.mostrar=function(){g.style.display="block"};this.ocultar=function(){g.style.display="none"};var n=(function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(r){window.clearTimeout(r)}})();var p=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(r){animate=window.setTimeout(r,1000/60);return animate}})();var e=function(){n(c);n(a)};this.cancelar_caida=function(){f=true;e()};this.establecer_comienzo=function(s){b=m;h=0;var r=(nodo_area_juego.clientWidth/nivel[s].columnas);g.style.top="0px";var t=(r*b)+15;g.style.left=t+"px"};this.dejar_caer=function(t,x,u){e();f=false;function r(C){var B=(nodo_area_juego.clientWidth/nivel[t].columnas);var A=B*b;var D=(B*(b-C));var y=d/60;function F(G){return G<0}function E(){if(F(C)){return((D-A)>0)?true:false}else{return((D-A)<0)?true:false}}function z(){D=(D+(y*C));if(E()){g.style.left=(D+15)+"px";c=p(z)}else{g.style.left=(A+15)+"px";v()}}z()}function w(){var B=nodo_area_juego.clientHeight/(nivel[t].filas+1);var A=B*(h+1);var y=B*h;var C=d/60;function z(){y=y+C;if((y-A)<0){g.style.top=(y-5)+"px";a=p(z)}else{g.style.top=(A-5)+"px";s()}}z()}function s(){if(!f){if(h<nivel[t].filas){columna_anterior=b-1;columna_anterior=(columna_anterior<0)?b:columna_anterior;if(b<nivel[t].columnas&&x[b][h].activo){b++;r(1)}else{if(x[columna_anterior][h].activo){b--;r(-1)}else{v()}}}else{if(q){u(b)}}}}function v(){n(c);h++;w()}w()}}function Temporizador(q,p,e,s){var c=q;var g=0;var o=0;var r=false;var b=false;var a={inicio:0,fin:0};var n=(typeof(e)!="undefined")?e:90000;var t=(typeof(s)!="undefined")?s:"H:M:S";var d=function(){return g-o+n+999};this.finalizado=function(){return !r};this.cambiarNodo=function(v){c=v};this.setTiempo=function(v){n=v};this.setFormato=function(v){t=v};var u=function(v,x,w){regresarValor=function(){arreglo=t.split("");for(i=0;i<arreglo.length;i++){arreglo[i]=aplicar(arreglo[i])}return arreglo.join("")};addCeroInicial=function(y){return(y<10)?"0"+y:y};aplicar=function(y){switch(y){case"H":return addCeroInicial(v);break;case"h":return v;break;case"M":return addCeroInicial(x);break;case"m":return x;break;case"S":return addCeroInicial(w);break;case"s":return w;break;default:return y;break}};return regresarValor()};var h=function(v){getHours=function(){return Math.floor(v/1000/60/60)};getMinutes=function(){return Math.floor(v/1000/60-(60*getHours()))};getSeconds=function(){return Math.floor(v/1000-(60*60*getHours())-(60*getMinutes()))};return isNaN(v)?u("--","--","--"):u(getHours(),getMinutes(),getSeconds())};var f=function(){g-=(a.inicio-a.fin);a.inicio=0;a.fin=0};var m=function(){if(!b){o=new Date();if(d()>=1000){c.firstChild.nodeValue=h(d())}else{c.firstChild.nodeValue=0;r=false;b=true;p()}window.setTimeout(m,1000)}};this.iniciar=function(){g=new Date();r=true;b=false;m()};this.pause=function(){b=true;a.inicio=new Date();m()};this.play=function(){a.fin=new Date();f();b=false;m()};this.detener=function(){b=true;m()}}function PuntajeParcial(){var d=0;var e=0;var b=0;var a=new Array(25,30,40,55,75,100);var c=new Array(10,12,16,22,30,40);this.getPuntos=function(){return b};this.restablecer=function(){d=0;e=0;b=0};this.getAciertosConsecutivos=function(){return d};var f=function(g){return(g<0)?0:g};this.calcular=function(g){if(g){e=0;b+=a[d];d++}else{d=0;b-=c[e];b=f(b);e++}return b}}function Puntajes(){var b={obtenerUsuario:document.getElementById("obtenerUsuario"),overlay_pantalla:document.getElementById("overlay_pantalla"),records:document.getElementById("records"),ingresaUsuario:document.getElementById("ingresaUsuario")};var a=new Record();var c={mostrar:function(){b.overlay_pantalla.style.display="block";b.overlay_pantalla.style.opacity=0.3;b.ingresaUsuario.style.display="block"},ocultar:function(){b.overlay_pantalla.style.display="none";b.obtenerUsuario.value=""}};this.mostrarPuntajes=function(d){a.imprimir(d)};this.esNuevoRecord=function(e,d){if(a.esNuevo(e,d)){c.mostrar();b.obtenerUsuario.focus();b.obtenerUsuario.onkeyup=function(h){var g=window.event||h;var f=g.keyCode;if(f==13){nombre=this.value;if(nombre==null||nombre==""){nombre="anonimo"}a.acomodar(e,nombre,d);a.imprimir(d);b.ingresaUsuario.style.display="none";c.ocultar()}}}else{}}}function Record(){var MAX_USERS_RECORDS=3;var NIVELES=new Array("facil","medio","dificil");var COLUMNAS=2;var nodo={tbody:document.querySelector("#records table tbody"),celda:{}};var crearCeldas=function(numRenglones){for(var i=0;i<numRenglones;i++){nodoTr=document.createElement("tr");nodo.tbody.appendChild(nodoTr);for(var j=0;j<COLUMNAS;j++){nodoTd=document.createElement("td");nodoTr.appendChild(nodoTd);nodoTd.appendChild(document.createTextNode(""))}}};var eliminarCeldas=function(numRenglones){for(var i=0;i<numRenglones;i++){nodo.tbody.removeChild(nodo.tbody.lastChild)}};var establecerCeldas=function(){var numRenglonesCreados=document.querySelectorAll("#records table tbody tr").length;var numRenglones=MAX_USERS_RECORDS-numRenglonesCreados;if(numRenglones>0){crearCeldas(numRenglones)}else{if(numRenglones<0){eliminarCeldas(Math.abs(numRenglones))}}};var crearArray=function(){var crearArray=new Array();for(var i=0;i<MAX_USERS_RECORDS;i++){crearArray[i]="undefined"}return crearArray};var crearIndefinido=function(){juego={};for(var i=0;i<NIVELES.length;i++){juego[NIVELES[i]]={usuario:crearArray(),puntos:crearArray()}}return juego};this.indefinido={juego:crearIndefinido()};this.aTexto=function(objeto){txt="{";for(i in objeto){txt+="'"+i+"':{";for(j in objeto[i]){txt+="'"+j+"':{";for(k in objeto[i][j]){txt+="'"+k+"': [";for(l in objeto[i][j][k]){txt+="'"+objeto[i][j][k][l]+"',"}txt+="],"}txt+="},"}txt+="},"}txt+="}";return txt};this.aObjeto=function(cadena){return eval("("+cadena+")")};this.getRecords=function(){if(!localStorage.getItem("recordsDondeCaera")){localStorage.setItem("recordsDondeCaera",this.aTexto(this.indefinido))}return this.aObjeto(localStorage.getItem("recordsDondeCaera"))};var isValido=function(){};this.records=this.getRecords();this.esNuevo=function(newScore,dificultad){this.records=this.getRecords();return isNaN(this.records.juego[dificultad].puntos[MAX_USERS_RECORDS-1])||this.records.juego[dificultad].puntos[MAX_USERS_RECORDS-1]<newScore};this.imprimir=function(dificultad){establecerCeldas();nodo.celda.usuario=document.querySelectorAll("#records table tbody tr td:nth-child(odd)");nodo.celda.puntos=document.querySelectorAll("#records table tbody tr td:nth-child(even)");for(atributo in this.records.juego[dificultad]){for(i in this.records.juego[dificultad][atributo]){if(atributo=="puntos"){nodo.celda[atributo][i].firstChild.nodeValue=this.records.juego[dificultad][atributo][i]}else{nodo.celda[atributo][i].firstChild.nodeValue=this.records.juego[dificultad][atributo][i]}}}};this.acomodar=function(newScore,newName,dificultad){var j=0;for(i in this.records.juego[dificultad].puntos){if(isNaN(this.records.juego[dificultad].puntos[i])){this.records.juego[dificultad].puntos[i]=newScore;this.records.juego[dificultad].usuario[i]=newName;localStorage.setItem("recordsDondeCaera",this.aTexto(this.records));break}else{if(parseInt(this.records.juego[dificultad].puntos[i])<parseInt(newScore)||(parseInt(this.records.juego[dificultad].puntos[i])==parseInt(newScore)&&j>0)){j++;tempTiempo=this.records.juego[dificultad].puntos[i];tempNombre=this.records.juego[dificultad].usuario[i];this.records.juego[dificultad].puntos[i]=newScore;this.records.juego[dificultad].usuario[i]=newName;newScore=tempTiempo;newName=tempNombre;localStorage.setItem("recordsDondeCaera",this.aTexto(this.records))}}}}}function main(){juego=new Juego();juego.mostrarPuntajes();document.nivel.addEventListener("change",function(){juego.reconf()},false);document.querySelector("#new").addEventListener("click",function(){juego.iniciar()},false)}document.addEventListener("DOMContentLoaded",main,false);